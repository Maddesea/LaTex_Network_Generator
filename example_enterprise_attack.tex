% Enterprise Network Under Attack - Comprehensive Example
% Demonstrates all Agent 5 threat intelligence features
%
% This example shows a realistic APT scenario with:
% - MITRE ATT&CK techniques
% - CVSS vulnerabilities
% - IOCs and C2 servers
% - Kill chain progression
% - Threat actor attribution
% - Defensive controls
% - Compliance dashboards
% - Risk analysis

\documentclass[tikz,border=10pt]{standalone}
\usepackage{tikz}
\usepackage{xcolor}
\usepackage{ifthen}
\usepackage{colortbl}
\usetikzlibrary{positioning,shapes.geometric,arrows.meta,shadows.blur,decorations.markings}

\input{styles_config}
\input{node_definitions}
\input{network_layout}
\input{connection_renderer}
\input{threat_indicators}

\begin{document}
\begin{tikzpicture}[scale=0.8, transform shape, font=\sffamily]

% ===== NETWORK INFRASTRUCTURE =====

% Internet and Attacker
\createCloud{internet}{0}{12}{Internet}
\createAttacker{apt29}{-8}{12}{APT29}

% DMZ Layer
\createFirewall{fw1}{0}{9}{Perimeter Firewall}
\createServer{web1}{-3}{6}{Web Server}
\createServer{web2}{3}{6}{API Server}

% Internal Network
\createRouter{router1}{0}{3}{Core Router}
\createServer{app1}{-4}{0}{App Server}
\createServer{db1}{4}{0}{Database}
\createClient{admin1}{-6}{-3}{Admin Workstation}
\createClient{user1}{0}{-3}{User Workstation}

% Backup Systems
\createServer{backup1}{8}{0}{Backup Server}

% Honeypot
\createServer{honeypot}{-8}{6}{Honeypot}

% ===== NETWORK CONNECTIONS =====

% Normal traffic
\drawConnection{internet}{fw1}{HTTPS}
\drawEncryptedConnection{fw1}{web1}{TLS 1.3}
\drawEncryptedConnection{fw1}{web2}{TLS 1.3}
\drawConnection{web1}{router1}{Internal}
\drawConnection{web2}{router1}{Internal}
\drawConnection{router1}{app1}{App Traffic}
\drawConnection{router1}{db1}{Database}
\drawConnection{admin1}{router1}{Management}
\drawConnection{user1}{router1}{User Traffic}
\drawBidirectional{db1}{backup1}{Replication}

% Attack connections
\drawAttackConnection{apt29}{web1}{Exploit}
\drawSuspiciousConnection{web1}{app1}{Lateral Movement}
\drawAttackConnection{app1}{db1}{Credential Theft}
\drawAttackConnection{db1}{apt29}{Exfiltration}

% Honeypot decoy
\drawSuspiciousConnection{apt29}{honeypot}{Reconnaissance}

% ===== THREAT INTELLIGENCE FEATURES =====

% 1. CVSS Vulnerabilities
\markVulnerabilityCVSS{web1}{CVE-2024-0001}{9.8}{9.5}{9.2}
\cvssBadge{app1}{7.5}
\markVulnerability{db1}{CVE-2023-1234}{8.2}

% 2. MITRE ATT&CK Techniques
\attackTechnique{web1}{initial-access}{T1190}{Exploit Public-Facing}
\attackTechnique{app1}{privilege-escalation}{T1068}{Kernel Exploit}
\attackTechnique{db1}{credential-access}{T1003}{Credential Dump}

% 3. IOCs
\markMaliciousIP{apt29}{45.123.45.67}{Russia}{95}
\markC2Server{apt29}{evil.badactor.net}{APT29}
\markFileHashIOC{web1}{SHA256}{a1b2c3d4e5f6...}{Sunburst}

% 4. Threat Actor Attribution
\markThreatActorOrigin{apt29}{APT29 (Cozy Bear)}{Russia}{yes}

% 5. Defensive Controls
\markSecurityControl{fw1}{Firewall}{active}
\markIDS{router1}{Snort IDS}{12}
\markWAF{web1}{ModSecurity}{247}
\markEDR{admin1}{CrowdStrike}{protected}
\markEDR{user1}{CrowdStrike}{protected}
\markHoneypot{honeypot}{SSH Honeypot}
\markPatchStatus{web1}{0}{2025-01-15}
\markPatchStatus{app1}{3}{2025-01-10}
\markBackupStatus{db1}{2025-01-16}{current}
\markZeroTrust{admin1}{yes}

% 6. Network Segmentation
\drawSegmentBoundary{-5}{4.5}{5}{7.5}{DMZ}
\drawSegmentBoundary{-7}{-4}{9}{1.5}{Internal Network}

% ===== DASHBOARDS AND SUMMARIES =====

% Kill Chain Progression (Stage 5: Installation)
\drawKillChain{-15}{-8}{5}

% Threat Actor Profile
\drawThreatActorProfile{-15}{10}{APT29}{92}{SolarStorm 2025}{Espionage}

% NIST Compliance
\drawNISTCompliance{12}{10}{88}{92}{85}{78}{82}

% Security Status
\drawSecurityStatus{12}{6}{76}

% IOC Dashboard
\drawIOCDashboard{12}{2}

% Risk Matrix
\drawRiskMatrix{-15}{2}

% ATT&CK Matrix
\drawAttackMatrix{12}{-4}

% Defense Layers
\drawDefenseLayers{-15}{-3}

% SIEM Integration
\markSIEM{-15}{6}{Splunk}{4850}

% Threat Summary
\drawThreatSummary{-15}{-12}{0}

% Risk Prioritization
\drawRiskPriority{12}{-8}{1}{3}{5}{12}

% Incident Status
\drawIncidentStatus{-8}{-8}{INC-2025-042}{investigating}{Critical}

% Title
\node[font=\Large\bfseries] at (0,15) {Enterprise Network: APT29 Active Intrusion};
\node[font=\small] at (0,14.3) {Demonstrating Full Threat Intelligence Capabilities};

% Legend
\node[legend box, anchor=south west] at (-15,-14) {
    \begin{tabular}{ll}
        \multicolumn{2}{c}{\textbf{Legend}} \\
        \hline
        \textcolor{red}{Red Lines} & Attack Traffic \\
        \textcolor{orange}{Orange Lines} & Suspicious \\
        \textcolor{green!70!black}{Green Dots} & Protected \\
        \textcolor{blue}{Blue Boxes} & Segmentation \\
    \end{tabular}
};

\end{tikzpicture}
\end{document}
